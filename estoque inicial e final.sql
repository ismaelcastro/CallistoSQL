use Callisto

select mov.codp,
produto.apelido,
SUM(
case 
when mov.fES = 1 
and MovCtb.dsMovCtb 
NOT IN('Outras Saídas', 'Outras Entradas')
and year(mov.dtMov) = 2019
then mov.qtMov else 0 end) AS TotalEntradas,

SUM(
case 
when mov.fES = 1 
and MovCtb.dsMovCtb NOT IN('Outras Saídas', 'Outras Entradas')
and year(mov.dtMov) = 2019
then mov.vlMov else 0 end) AS vlTotalEntradas,

SUM(
case 
when mov.fES = -1 
and MovCtb.dsMovCtb NOT IN('Outras Saídas', 'Outras Entradas') 
and year( mov.dtMov) = 2019 
then mov.qtMov else 0 end) AS TotalSaidas,
SUM(
case 
when mov.fES = -1 
and MovCtb.dsMovCtb NOT IN('Outras Saídas', 'Outras Entradas') 
and year(mov.dtMov) = 2019
then mov.vlMov else 0 end) AS vlTotalSaida,
(SELECT top 1 FIRST_VALUE(qtSaldo) OVER(ORDER BY seqMov desc) FROM mov M where M.CODP = mov.CODP and cdFilial = 0 
	
	and (year(m.dtMov) < 2019)
)
AS 'Saldo Inicial',
(SELECT top 1 FIRST_VALUE(vlFinanceiro) OVER(ORDER BY seqMov desc) FROM mov M where M.CODP = mov.CODP and cdFilial = 0 
	
	and (year(m.dtMov) < 2019)
)
AS 'Valor Financeiro Inicial',

(SELECT top 1 FIRST_VALUE(qtSaldo) OVER(ORDER BY seqMov desc) FROM mov M where M.CODP = mov.CODP and cdFilial = 0
and (year(m.dtMov) < 2020)
)
AS 'Saldo Final',

(SELECT top 1 FIRST_VALUE(vlFinanceiro) OVER(ORDER BY seqMov desc) FROM mov M where M.CODP = mov.CODP and cdFilial = 0
and (year(m.dtMov) < 2020)
)
AS 'Valor Financeiro Final'
FROM mov(nolock) left outer join CCusto(nolock) on mov.cdDepto = CCusto.cdDepto
left outer join natOper(nolock) on mov.cdNat = natOper.cdNat
inner join movctb(nolock) on mov.cdMovCtb = movctb.cdMovCtb
inner join produto on mov.codp = produto.codp
where mov.CODP IN (
2753,4947,996,5178,2597,6672,5670,5180,4949,982,1956,5573,4683,1494,5636,4954,1305,1542,4991,1638,2078,6313,2331,758,1031,3054,1695,1516,5083,3081,5081,5239,1400,1900,1514,1034,2693,6216,4989,5678,1684,4909,5810,3169,911,782,3047,4760,5094,5700,4996,1554,5743,992,4485,6539,5102,6548,6356,5299,3917,3194,1955,5444,4492,6753,4881,5972,5570,816,4929,5302,5287,2464,2029,5348,4199,1045,5041,4720,6217,6754,5035,3015,2329,1307,5079,5887,3098,3172,406,4889,1308,172,1976,1145,5130,577,1344,5031,391,985,1512,5319,4149,5284,3844,1810,4147,4154,1685,2364,3488,2666,4772,848,6640,4211,1881,3991,1962,1680,1414,4266,6235,6027,5084,5098,2209,2750,6755,812,1122,3062,979,5129,3481,1655,717,3843,1354,1747,1036,4529,1177,1541,6534,709,6418,1487,1660,4495,4015,1520,2747,2748,1340,1244,1709,3993,1211,52,2779,2508,3202,94,678,2542,819,6224,5416,1273,1266,6298,5196,374,5136,1374,6397,2634,5006,4890,3653,5101,5413,2610,1338,5202,4170,2970,2526,1756,6299,1148,5269,1389,2366,5148,474,2066,34,6245,1248,4773,1046,2378,3224,4455,4918,1330,6470,148,1242,4771,2694,5367,1147,1829,2478,84,1180,555,1239,49,722,5139,274,86,1737,1250,326,730,2737,1265,685,4003,1240,5186,743,3998,2347,3347,2352,2437,2569,2116,3375,2365,3637,144,76,2690,1071,5191,4163,1035,6617,244,2531,1234,1738,2031,335,6331,3156,302,324,5093,5415,1727,5462,713,5549,756,5149,818,2438,3319,1731,5661,341,1125,2721,1236,1237,1246,402,1893,4028,13,2574,723,570,5341,196,259,519,1743,714,127,677,650,454,1759,726,4462,2763,1739,1733,275,689,16,5085,2555,6249,1243,395,5463,345,2431,2435,534,1418,246,1726,6616,2436,551,1750,1761,5417,435,1207,97,2702,2570,142,75,742,2590,532,1748,2760,466,764,4117,405,1730,456,6128,695,3628,4148,1325,740,4517,1736,264,4738,1231,4234,429,1749,516,515,6652,4696,6713,2196,1229,1613,1614,2432,1044,5544,5545,5546,671,6251,1535,1692,1466,5428,4423,5372,4988,941,5543,6537,3070,1989,5489,4966,2015,4990,3055,3226,6028,2541,3170,5768,5049,5702,5445,6538,1550,5775,604,611,2212,6029,2210,657,2831,5040,6337,594,2248,1993,5640,892,6269,1041,3173,849,5703,3992,6540,6787,6716,2723,6712,4897,4898,983,489,5443,1544,1545,1543,4748,1715,2749,2751,4171,4172,2234,1706,1329,5308,5686,3019,2135,4479,5144,981,5731,6653,6069,6070,5495,6355,5704,851,4205,1519,1562,5760,1,5705,2298,1422,3223,1560,5701,1037,1551,5776,3225,6729,3120,5297,6440,2762,4128,15,1386,2370,2368,2369,4228,4229,2377,3128,3130,4218,3150,5346,4219,4220,4222,4226,4223,4224,4227,4225,6247,4217,2669,2372,3151,2373,2367,5128,2374,2375,2376,3136,4216,3135,3127,565,5195,17,5192,18,652,19,20,2313,2314,3402,6141,3376,5402,6330,6329,4020,5779,6550,2429,2430,2503,3411,1080,1139,4895,6314,4027,5349,1745,5347,2609,5461,5331,3104,3103,1051,4894,4893,661,56,65,67,3072,4118,2829,2828,2827,2536,1725,3099,3638,1306,1179,2415,4235,3863,1741,382,1732,100,1734,6719,2707,2178,112,808,123,124,1755,1735,90,5201,137,1286,535,620,1973,778,143,1249,122,146,149,792,507,347,3121,3512,5526,2090,662,5303,5566,6722,2792,5998,3458,5460,775,3010,647,6721,6334,46,2969,6723,530,715,250,627,2841,5301,5926,508,522,3102,4557,2807,4688,5908,2705,5193,2008,188,1097,2032,772,185,5187,186,2708,3113,1216,2445,2783,5134,1210,1923,175,3956,2917,5535,193,6482,197,1295,643,609,2379,3145,2608,2337,683,212,2338,5082,5298,1280,5359,3859,1155,1143,649,6727,6728,648,651,2118,2537,5803,3292,6353,2207,6366,3364,240,2793,2594,3126,1718,768,660,3165,245,248,2710,1746,771,256,5437,2842,6226,2830,504,2825,261,2383,2381,2826,2382,5792,271,501,6725,4202,3020,3146,3639,2592,5288,1264,3957,3958,2423,2194,2115,2507,2575,2758,3816,5720,3475,3476,5097,4560,3184,1081,1082,5721,5719,1764,3356,1213,2166,278,6613,2110,1185,5198,5200,5199,6333,4152,1393,3185,3195,3219,290,773,4210,298,299,1752,4899,547,300,1753,3131,3132,3133,1751,5737,3147,5410,5300,5657,6761,6466,330,332,3388,5099,5804,4167,4165,5766,4559,5733,4166,2607,3125,331,334,803,5096,6471,3374,336,4146,4200,2388,2390,343,1223,5342,2797,1182,5920,2916,1245,6416,5286,5790,6549,5631,1861,2724,3039,523,5126,367,6054,2386,5350,5826,1302,646,370,372,2586,373,5197,5080,3287,4667,3290,2219,2387,1224,378,513,376,377,5551,379,380,1610,6142,2332,3080,1860,3043,1957,4821,4233,6350,6248,5132,2780,5131,2781,5133,2782,5756,6401,561,5343,1760,5550,1758,2176,3362,6417,1972,2730,5135,2784,2114,3708,3627,5572,6780,2729,408,411,414,1878,1072,318,1262,1128,2546,5412,6465,3389,2170,1175,5189,317,5190,319,3858,5734,2657,3299,2843,3317,2549,3318,6614,2548,2844,2791,323,5188,2551,724,6352,2711,4558,728,2477,4556,422,307,314,6720,780,1744,2426,2447,762,1742,2414,2380,5765,430,3459,434,437,6207,441,3710,5571,6552,4164,5414,6143,5194,449,448,450,451,5137,6547,5289,6243,6615,2971,1238,3365,1260,735,731,1131,733,1256,2786,1251,739,738,737,1252,1258,2788,1140,1254,734,1259,2790,741,2427,732,1253,2785,736,1257,2787,1133,1255,461,4827,1235,184,5569,3071,1971,6140,476,477,2339,478,1754,624,6129,2697,601,2761,1928,6088,6395,2428,481,1181,4230,483,1952,1176,2006,6724,4900,3013,5735,5736,4896,3139,3140,3144,3141,3143,3142,5344,3149,521,5642,4891,5509,4956,2344,2059,2687,838,4940,3040,542,4774,5340,5234,5233,4023,4255,253,4726,5732,942,5309,357,3016,2722,39,518,2099,3088,3691,2759,691,642,511,279,670,2038,3152,301,436,2117,2789,639,5988,2371

)
and mov.cdFilial = 0 
and (mov.dtMov >= dbo.DTI('01/01/2010'))
and (mov.dtMov <= dbo.DTF('31/12/2019'))
and mov.seqMov is not null
and mov.fEstoque = 'S'
and mov.fNTE = 'N'
--and movctb.fMov is not null
and isnull(mov.fCusto,'M') = 'M'
and (null is null or movctb.cdMovCtb is null)
and exists (select 1 from SaldoNEP where SaldoNEP.cdi=Mov.cdi) -- não vai mostrar dados anteriores a 2018, implantação do saldoNEP
GROUP BY mov.codp, produto.apelido order by mov.codp
